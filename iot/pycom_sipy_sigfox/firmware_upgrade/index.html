<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Markus J&uuml;nemann">
        <link rel="canonical" href="https://mjuenema.github.io/iot/pycom_sipy_sigfox/firmware_upgrade/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">

	<title>Pycom SiPy and Sigfox Firmware Upgrade - Markus J&uuml;nemann</title>

        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">
        <link href="../../../css/base.css" rel="stylesheet">
        <link href="../../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../../..">Markus J&uuml;nemann</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../../..">Home</a>
                </li>
            
            
            
                <li >
                    <a href="../../../installing_gns3_on_centos7/">Installing GNS3 on CentOS 7</a>
                </li>
            
            
            
                <li >
                    <a href="../../../basic_ipv6_on_cisco_ios/">Basic IPv6 on Cisco IOS</a>
                </li>
            
            
            
                <li >
                    <a href="../../../testing_python_code_with_hypothesis/">Testing Python Code with Hypothesis</a>
                </li>
            
            
            
                <li >
                    <a href="../../../80211s_wireless_mesh/">802.11s Wireless Mesh Network</a>
                </li>
            
            
            
                <li >
                    <a href="../">Pycom SiPy and Sigfox</a>
                </li>
            
            
            
                <li >
                    <a href="../encrypting_sigfox_messages/">Pycom SiPy and Sigfox Encrypting Sigfox messages</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Pycom SiPy and Sigfox Firmware Upgrade</a>
                </li>
            
            
            
                <li >
                    <a href="../introduction_to_sipy/">Pycom SiPy and Sigfox Introduction to SiPy</a>
                </li>
            
            
            
                <li >
                    <a href="../sending_sigfox_message/">Pycom SiPy and Sigfox Sending Sigfox message</a>
                </li>
            
            
            
                <li >
                    <a href="../sigfox_backend/">Pycom SiPy and Sigfox Sending Sigfox message</a>
                </li>
            
            
            
                <li >
                    <a href="../sigfox_downlink/">Pycom SiPy and Sigfox Sending Sigfox message</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../encrypting_sigfox_messages/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../introduction_to_sipy/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/mjuenema">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#building-the-sipy-firmware">Building the SiPy Firmware</a></li>
        
            <li><a href="#preparing-the-build-environment">Preparing the build environment</a></li>
        
            <li><a href="#customising-the-build">Customising the build</a></li>
        
            <li><a href="#adding-python-modules">Adding Python modules</a></li>
        
            <li><a href="#building-the-firmware">Building the firmware</a></li>
        
            <li><a href="#uploading-the-firmware">Uploading the firmware</a></li>
        
            <li><a href="#links">Links</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="building-the-sipy-firmware">Building the SiPy Firmware</h1>
<p>The first question you have to ask yourself is, why would you go through the
trouble of building a custom firmware. I've done this often enough for other devices
and it isn't always the easiest of exercises. So why bother doing it? In case of the
Pycom SiPy the answer lies in hardware quirk. Any Python modules that are pre-compiled
 and stored in flash memory don't require any RAM when imported. The SiPy
has very little RAM and it is easy to run out of memory when importing larger
Python modules. This happened to me when I tried to import the
<a href="https://pypi.python.org/pypi/bitstring">bitstring</a> module from SD card.</p>
<h2 id="preparing-the-build-environment">Preparing the build environment</h2>
<p>First one has to install a few required software packages. The example below applies
to Fedora so if you run a different distribution the package names may be different.</p>
<pre><code>$ sudo yum install git wget make ncurses-devel flex bison gperf python pyserial
</code></pre>

<p>Next download and extract the cross-compiler. I keep everything under the
<code>$HOME/Projects/IoT/Pycom/ESP</code> path but that's just my personal setup.</p>
<pre><code>$ cd /tmp
$ wget https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-1.22.0-61-gab8375a-5.2.0.tar.gz
$ cd $HOME/Projects/IoT/Pycom/ESP
$ tar xvfz /tmp/xtensa-esp32-elf-linux64-1.22.0-61-gab8375a-5.2.0.tar.gz
</code></pre>

<p>Next clone the necessary Pycom Git repositories. Pycom  maintain their
own fork of MicroPython.</p>
<pre><code>$ cd $HOME/Projects/IoT/Pycom/ESP
$ git clone --recursive https://github.com/pycom/pycom-esp-idf.git
$ git clone --recursive https://github.com/pycom/pycom-micropython-sigfox.git
</code></pre>

<h2 id="customising-the-build">Customising the build</h2>
<p>Next edit the key C header file and add the <code>#define...</code> line as show below. This
enables the feature to load pre-compiled <code>*.mpy</code> code. By default this is 
dsiabled. <code>*.mpy</code> files are MicroPython's equivalent to <code>*.pyc</code> files.</p>
<pre><code>$ cd $HOME/Projects/IoT/Pycom/ESP/pycom-micropython-sigfox/esp32/
$ vi mpconfigport.h
#define MICROPY_PERSISTENT_CODE_LOAD (1)
</code></pre>

<p>It is important to amend the <code>PATH</code> and set <code>IDF_PATH</code> before proceeding.</p>
<pre><code>$ export PATH=$PATH:$HOME/Projects/IoT/Pycom/ESP/xtensa-esp32-elf/bin
$ export IDF_PATH=$HOME/Projects/IoT/Pycom/ESP/pycom-esp-idf
</code></pre>

<p>Now build the MicroPython pre-compiler.</p>
<pre><code>$ cd $HOME/Projects/IoT/Pycom/ESP/pycom-micropython-sigfox/mpy-cross
$ make clean
$ make all
</code></pre>

<h2 id="adding-python-modules">Adding Python modules</h2>
<p>This is the moment to add any Python modules that are meant to be built into
the firmware. Simply copy them to the <code>frozen/</code> folder. That's all. The <code>frozen/</code>
folder already contains a <code>_boot.py</code> file which is <em>not</em> the <code>/flash/boot.py</code>
script. Don't remove <code>_boot.py</code> as without it the SiPy won't start.</p>
<pre><code>$ cd $HOME/Projects/IoT/Pycom/ESP/pycom-micropython-sigfox/esp32/
$ ls frozen/
_boot.py
</code></pre>

<h2 id="building-the-firmware">Building the firmware</h2>
<p>Eventually the firmware and bootloader can be build.</p>
<pre><code>$ cd $HOME/Projects/IoT/Pycom/ESP/pycom-micropython-sigfox/esp32/
$ make BOARD=SIPY TARGET=boot V=1 clean
$ make BOARD=SIPY TARGET=boot V=1
$ make BOARD=SIPY TARGET=app V=1
</code></pre>

<h2 id="uploading-the-firmware">Uploading the firmware</h2>
<p>The <code>Makefile</code> also allows to upload the new firmware to the SiPy.
Connect pin P2 (G23 on the expansion board) to GND with a jumper wire 
and press the reset
button. The adjust the permissions on the <code>/dev/ttyUSBx</code> device and
upload the firmware. This takes only a few seconds.</p>
<pre><code>$ sudo chmod a+rw /dev/ttyUSB0
$ make BOARD=SIPY flash
</code></pre>

<p>Remove the jumper wire and power-cycle the SiPy. The SiPy should have booted
into the new firmware.</p>
<pre><code>&gt;&gt;&gt; os.uname()
(sysname='SiPy', nodename='SiPy', release='1.7.3.b2', 
 version='41c42b2-dirty on 2017-06-23', machine='SiPy with ESP32', sigfox='1.0.1')
</code></pre>

<p>If the firmware upload failed the SiPy will show a bright red LED. Don't panic,
and follow 
<a href="https://forum.pycom.io/topic/1343/solved-lopy-bricked-red-led">these instructions</a>.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="http://esp-idf.readthedocs.io/en/latest/get-started/linux-setup.html">Standard Setup of ESP-IDF Toolchain for Linux</a></li>
<li><a href="https://github.com/pycom/pycom-micropython-sigfox">Pycom fork of MicroPython source</a> - see <code>esp32</code> folder for Pycom SiPy.</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>